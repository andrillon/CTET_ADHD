%%
clear all;
% close all;
run ../localdef_ADHD_CTET.m

addpath(path_fieldtrip);
ft_defaults;
addpath(genpath(path_fooof))
addpath(genpath(path_LSCPtools));

files=dir([data_path filesep 'Preproc' filesep 'CIcfe_ft_*.mat']);

% table=readtable([save_path 'CTET_behav_res.txt']);
% load('../ICA_Artifacts.mat')

%% Layout
cfg = [];
cfg.layout = 'biosemi64.lay';
cfg.center      = 'yes';
layout=ft_prepare_layout(cfg);
load('../ADHD_CTET_task_BadChannels.mat')

redo=1;
%%
nFc=0;
all_ERP_NT=[];
all_ERP_TG=[];
for nF=1:length(files)
    file_name = files(nF).name;
    folder_name = files(nF).folder;
    SubIDlong=file_name(10:end-4);
    SubID=file_name(10:end-4);
    seps=findstr(SubID,'_');
    SubID=SubID(1:seps(1)-1);
    
    table=readtable([save_path filesep 'CTET_ADHD_behav_' SubID '_CTET.txt']);
    
 
    nFc=nFc+1;
    fprintf('... processing %s\n',file_name);
    load([data_path filesep  'Preproc'  filesep file_name(1:end-4)]);
    
    cfg=[];
    cfg.reref           = 'yes';
    cfg.refchannel      = 'all';
    cfg.demean          = 'yes';
    cfg.baselinewindow  = [-0.2 0];
    data_clean = ft_preprocessing(cfg,data);
    
    %%% take out trial
    thisF=match_str(badChannels_table.FileName,['fe_ft_' SubIDlong]);
    if isempty(thisF)
        continue;
    end
    eval(['badTrials=[' badChannels_table.Bad_Trials{thisF} '];']);
    table(ismember(table.TrialN,badTrials),:)=[];
    table.StimType(find(diff(table.BlockN)==1 | diff(table.StimType)==1))=NaN;
    
    % COMPUTE BOTH ONSET AND OFFSET ERP
    cfgerp        = [];
    %     cfgerp.latency        = [-0.2 0.8];
    cfgerp.trials = find(table.StimType==0); %cfgerp.trials(cfgerp.trials>length(data_clean.trial))=[];
    av_data_NT = ft_timelockanalysis(cfgerp, data_clean);
    cfgerp.trials = find(table.StimType==1); %cfgerp.trials(cfgerp.trials>length(data_clean.trial))=[];
    av_data_TG = ft_timelockanalysis(cfgerp, data_clean);
    
    ERP_NT=av_data_NT.avg; %(:,av_data_NT.time>-0.2 & av_data_NT.time<0.8);
    all_ERP_NT(nFc,:,:)=ERP_NT;
    
    ERP_TG=av_data_TG.avg; %(:,av_data_TG.time>-0.2 & av_data_TG.time<0.8);
    all_ERP_TG(nFc,:,:)=ERP_TG;
        
    cfgerp2        = [];
    cfgerp2.trials = find(table.StimType==0)+1; cfgerp2.trials(cfgerp2.trials>length(data_clean.trial))=[];
    av_data_NT_offset = ft_timelockanalysis(cfgerp2, data_clean);
    cfgerp2.trials = find(table.StimType==1)+1; cfgerp2.trials(cfgerp2.trials>length(data_clean.trial))=[];
    av_data_TG_offset = ft_timelockanalysis(cfgerp2, data_clean);
    
    ERP_NT_offset=av_data_NT_offset.avg(:,av_data_NT_offset.time>-0.2 & av_data_NT_offset.time<0.8)-repmat(mean(av_data_NT_offset.avg(:,av_data_NT_offset.time>-0.2 & av_data_NT_offset.time<0),2),1,sum(av_data_NT_offset.time>-0.2 & av_data_NT_offset.time<0.8));
    all_ERP_NT_offset(nFc,:,:)=ERP_NT_offset;
    
    ERP_TG_offset=av_data_TG_offset.avg(:,av_data_TG_offset.time>-0.2 & av_data_TG_offset.time<0.8)-repmat(mean(av_data_TG_offset.avg(:,av_data_TG_offset.time>-0.2 & av_data_TG_offset.time<0),2),1,sum(av_data_TG_offset.time>-0.2 & av_data_TG_offset.time<0.8));
    all_ERP_TG_offset(nFc,:,:)=ERP_TG_offset;
end

xTime=av_data_NT.time;
chLabels=av_data_NT.label;
xTime_offset=av_data_TG_offset.time(av_data_TG_offset.time>-0.2 & av_data_TG_offset.time<0.8);


%%

thisCh=match_str(chLabels,'Pz');

figure;
plot(xTime,squeeze(nanmean(all_ERP_NT(:,thisCh,:),1)),'k')
hold on;
plot(xTime,squeeze(nanmean(all_ERP_TG(:,thisCh,:),1)),'r')

all_DrugC2=all_DrugC;
all_DrugC2(NT_ITI>1)={'wrongITI'};

figure;
set(gcf,'Position',[1         378        1396         420]);
% ColorsD={[1 1 1]*0.5,[84 81 153]/255,[170 75 21]/255,[75 128 90]/255};
% ColorsDlabels={'PLA','ATM','MPH','CIT'};
for nDrug=1:4
    subplot(1,4,nDrug);
    hp=[];
    [~,hp(1)]=simpleTplot(xTime,squeeze(all_ERP_NT(match_str(all_DrugC2,ColorsDlabels{nDrug}),thisCh,:)),0,'k',0,'-',0.5,1,5,1,3);
    hold on;
    [~,hp(2)]=simpleTplot(xTime,squeeze(all_ERP_TG(match_str(all_DrugC2,ColorsDlabels{nDrug}),thisCh,:)),0,'r',0,'-',0.5,1,5,1,3);
    title(ColorsDlabels{nDrug})
    ylim([-2 10])
    xlim([-0.2 1.8])
    format_fig;
    xlabel('Time from Onset')
    ylabel('ERP (\muV)')
end

%%
figure;
set(gcf,'Position',[1         378        1396         420]);
% ColorsD={[1 1 1]*0.5,[84 81 153]/255,[170 75 21]/255,[75 128 90]/255};
% ColorsDlabels={'PLA','ATM','MPH','CIT'};
hp=[];
for nDrug=1:4
    [~,hp(nDrug)]=simpleTplot(xTime,squeeze(all_ERP_TG(match_str(all_DrugC2,ColorsDlabels{nDrug}),thisCh,:)-...
        all_ERP_NT(match_str(all_DrugC2,ColorsDlabels{nDrug}),thisCh,:)),0,Colors(nDrug,:),[2 0.05 0.0001 1000],'-',0.5,1,5,1,3);
    title(ColorsDlabels{nDrug})
    %     ylim([-2 10])
    xlim([-0.2 1.8])
    format_fig;
    xlabel('Time from Onset')
    ylabel('ERP (\muV)')
end
legend(hp,ColorsDlabels)
%%
winTime1=[0.8 1.15];
winTime2=[1.25 1.5];

cfg = [];
cfg.layout = 'biosemi64.lay';
cfg.channel=chLabels;
cfg.center      = 'yes';
layout=ft_prepare_layout(cfg);

figure;
subplot(1,2,1); format_fig;
topo_TG_win1=squeeze(nanmean(nanmean(all_ERP_TG(:,:,xTime>winTime1(1) & xTime<winTime1(2)),1),3));
% simpleTopoPlot_ft(topo_TG_win1(1:64)', layout,'labels',[],0,1);
% colorbar;

% subplot(2,2,1); format_fig;
topo_NT_win1=squeeze(nanmean(nanmean(all_ERP_NT(:,:,xTime>winTime1(1) & xTime<winTime1(2)),1),3));
simpleTopoPlot_ft(topo_TG_win1(1:64)'-topo_NT_win1(1:64)', layout,'labels',[],0,1);
colorbar;
caxis([-1 1]*3)

subplot(1,2,2); format_fig;
topo_TG_win2=squeeze(nanmean(nanmean(all_ERP_TG(:,:,xTime>winTime2(1) & xTime<winTime2(2)),1),3));
% simpleTopoPlot_ft(topo_TG_win2(1:64)', layout,'labels',[],0,1);
% colorbar;
%
% subplot(2,2,3); format_fig;
topo_NT_win2=squeeze(nanmean(nanmean(all_ERP_NT(:,:,xTime>winTime2(1) & xTime<winTime2(2)),1),3));
simpleTopoPlot_ft(topo_TG_win2(1:64)'-topo_NT_win2(1:64)', layout,'labels',[],0,1);
colorbar;
caxis([-1 1]*5)

%%
figure;
for nDrug=1:4
    subplot(4,2,1+2*(nDrug-1)); format_fig;
    topo_TG_win1=squeeze(nanmean(nanmean(all_ERP_TG(match_str(all_DrugC2,ColorsDlabels{nDrug}),:,xTime>winTime1(1) & xTime<winTime1(2)),1),3));
    topo_NT_win1=squeeze(nanmean(nanmean(all_ERP_NT(match_str(all_DrugC2,ColorsDlabels{nDrug}),:,xTime>winTime1(1) & xTime<winTime1(2)),1),3));
    simpleTopoPlot_ft(topo_TG_win1(1:64)'-topo_NT_win1(1:64)', layout,'on',[],0,1);
    colorbar;
    caxis([-1 1]*3)
    
    subplot(4,2,2+2*(nDrug-1)); format_fig;
    topo_TG_win2=squeeze(nanmean(nanmean(all_ERP_TG(match_str(all_DrugC2,ColorsDlabels{nDrug}),:,xTime>winTime2(1) & xTime<winTime2(2)),1),3));
    topo_NT_win2=squeeze(nanmean(nanmean(all_ERP_NT(match_str(all_DrugC2,ColorsDlabels{nDrug}),:,xTime>winTime2(1) & xTime<winTime2(2)),1),3));
    simpleTopoPlot_ft(topo_TG_win2(1:64)'-topo_NT_win2(1:64)', layout,'on',[],0,1);
    colorbar;
    caxis([-1 1]*5)
end

%%
thisCh=match_str(chLabels,'Oz');

all_DrugC2=all_DrugC;
all_DrugC2(NT_ITI>1)={'wrongITI'};

figure;
set(gcf,'Position',[1         378        1396         420]);
% ColorsD={[1 1 1]*0.5,[84 81 153]/255,[170 75 21]/255,[75 128 90]/255};
% ColorsDlabels={'PLA','ATM','MPH','CIT'};
for nDrug=1:4
    subplot(1,4,nDrug);
    hp=[];
    [~,hp(1)]=simpleTplot(xTime_offset,squeeze(all_ERP_NT_offset(match_str(all_DrugC2,ColorsDlabels{nDrug}),thisCh,:)),0,'k',0,'-',0.5,1,5,1,3);
    hold on;
    [~,hp(2)]=simpleTplot(xTime_offset,squeeze(all_ERP_TG_offset(match_str(all_DrugC2,ColorsDlabels{nDrug}),thisCh,:)),0,'r',0,'-',0.5,1,5,1,3);
    title(ColorsDlabels{nDrug})
    ylim([-2.5 9])
    xlim([-0.2 0.8])
    format_fig;
    xlabel('Time from Offset')
    ylabel('ERP (\muV)')
end

figure;
% set(gcf,'Position',[1         378        1396         420]);
hp=[];
for nDrug=1:4
    [~,hp(nDrug)]=simpleTplot(xTime_offset,squeeze(all_ERP_TG_offset(match_str(all_DrugC2,ColorsDlabels{nDrug}),thisCh,:)-...
        all_ERP_NT_offset(match_str(all_DrugC2,ColorsDlabels{nDrug}),thisCh,:)),0,Colors(nDrug,:),[0 0.05 0.0001 1000],'-',0.5,1,5,1,3);
    title(ColorsDlabels{nDrug})
    %     ylim([-2 10])
    xlim([-0.2 0.8])
    format_fig;
    xlabel('Time from Offset')
    ylabel('ERP (\muV)')
end
legend(hp,ColorsDlabels)